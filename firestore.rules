rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection
    match /users/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == uid;

      // Notifications subcollection
      match /notifications/{notificationId} {
        // Users can read their own notifications
        allow read: if request.auth != null && request.auth.uid == uid;
        // Anyone can create a notification (for mentions)
        allow create: if request.auth != null;
        // Users can delete/update their own notifications (e.g., mark as read)
        allow update, delete: if request.auth != null && request.auth.uid == uid;
      }
    }

    // Global config, including admin emails
    match /config/admin {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Universities collection
    match /universities/{universityId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;

      match /dorms/{dormId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }

   // Events collection
    match /events/{eventId} {
      // Allow any authenticated user to read events
      allow read: if request.auth != null;
      // Allow creates from authenticated users
      allow create: if request.auth != null;
      // Only host can update/delete their own event, OR any authenticated user can update likes
      allow update: if
        request.auth != null &&
        (request.auth.uid == resource.data.hostUserId ||
         // Allow updating only the likes field
         (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])));
      allow delete: if
        request.auth != null &&
        request.auth.uid == resource.data.hostUserId;

      // Nested comments for each event
      match /comments/{commentId} {
        // Any signed-in user can read comments
        allow read: if request.auth != null;
        // Any signed-in user can add a comment
        allow create: if request.auth != null;
        // Only comment author can update/delete their own comment
        // Check both 'authorUid' and 'uid' for backwards compatibility
        // However, anyone can update just the 'likes' field
        allow update: if
          request.auth != null &&
          ((request.auth.uid == resource.data.authorUid || request.auth.uid == resource.data.uid) ||
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']));
        allow delete: if
          request.auth != null &&
          (request.auth.uid == resource.data.authorUid || request.auth.uid == resource.data.uid);

        // Reports subcollection for comments
        match /reports/{reportId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null;
          allow update, delete: if false; // Only admins via console
        }
      }
    }

    // Recursive rule for ALL replies (at any nesting level)
    match /{path=**}/replies/{replyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if
        request.auth != null &&
        ((request.auth.uid == resource.data.authorUid || request.auth.uid == resource.data.uid) ||
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']));
      allow delete: if
        request.auth != null &&
        (request.auth.uid == resource.data.authorUid || request.auth.uid == resource.data.uid);
    }

    // Recursive rule for ALL reports (comments, replies, etc)
    match /{path=**}/reports/{reportId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false; // Only admins via console
    }

    // Comment reports collection (legacy/top-level if used)
    match /commentReports/{reportId} {
      // Any authenticated user can create a report
      allow create: if request.auth != null;
      // No one can read, update, or delete (admin only via console)
      allow read, update, delete: if false;
    }

    // Everything else locked down
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

